@model GameListVm
@{
    ViewData["Title"] = "Game Store - Browse Games";
}

<link rel="stylesheet" href="~/css/modern-ui.css" />

<header class="hero-section">
    <img src="~/images/logo.png" alt="EGameStore" class="hero-logo">
    <a href="#browse-section" class="hero-scroll-btn">
        <i class="bi bi-chevron-down"></i>
    </a>
</header>

<div id="browse-section" class="filter-section my-4">
    <form asp-action="Index" class="row g-3 align-items-end">
        <input type="hidden" name="page" value="1" />
        
        <div class="col-md-3">
            <div class="filter-control">
                <label for="genreId" class="form-label">
                    <i class="bi bi-funnel-fill"></i> Genre
                </label>
                <select class="form-select" id="genreId" name="genreId" onchange="this.form.submit()">
                    <option value="0" selected="@(Model.GenreId == 0)">All Genres</option>
                    @foreach (var genre in Model.Genres)
                    {
                        <option selected="@(Model.GenreId == genre.Id)" value="@genre.Id">@genre.GenreName</option>
                    }
                </select>
            </div>
        </div>

        <div class="col-md-3">
            <div class="filter-control">
                <label for="maxPrice" class="form-label">
                    <i class="bi bi-tag-fill"></i> Max Price: <span id="priceValue">$@(Model.SelectedMaxPrice?.ToString("0") ?? Model.MaxPrice.ToString("0"))</span>
                </label>
                <input type="range" class="form-range" id="maxPrice" name="maxPrice" 
                       min="0" max="@Model.MaxPrice" step="5" 
                       value="@(Model.SelectedMaxPrice ?? Model.MaxPrice)" 
                       oninput="document.getElementById('priceValue').innerText = '$' + this.value"
                       onchange="this.form.submit()">
            </div>
        </div>

        <div class="col-md-4">
            <div class="filter-control">
                <label for="sTerm" class="form-label">
                    <i class="bi bi-search"></i> Search
                </label>
                <div class="input-group-modern">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="sTerm" name="sTerm" value="@Model.STerm" placeholder="Search title...">
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-modern btn-search flex-fill">
                    <i class="bi bi-search"></i>
                </button>
                <a href="/Home/Index" class="btn btn-modern btn-reset">
                    <i class="bi bi-arrow-clockwise"></i>
                </a>
            </div>
        </div>
    </form>
</div>

<div class="container">
    <div class="row g-4">
        @foreach (var game in Model.Games)
        {
            <div class="col-lg-4 col-md-6">
                <div class="game-card">
                    <div class="game-card-image">
                        @if (string.IsNullOrEmpty(game.Image))
                        {
                            <img src="~/images/noImage.jpg" alt="No Image Available">
                        }
                        else
                        {
                            <img src="@game.Image" alt="@game.GameName">
                        }
                    </div>
                    
                    <div class="game-card-body">
                        <h5 class="game-card-title">@game.GameName</h5>
                        
                        <div class="update-time">
                            <i class="bi bi-clock"></i>
                            @if (game.UpdatedDate.HasValue)
                            {
                                var timeAgo = DateTime.Now - game.UpdatedDate.Value;
                                if (timeAgo.TotalMinutes < 1)
                                {
                                    <text>Updated just now</text>
                                }
                                else if (timeAgo.TotalHours < 1)
                                {
                                    <text>Updated @((int)timeAgo.TotalMinutes) min@(timeAgo.TotalMinutes >= 2 ? "s" : "") ago</text>
                                }
                                else if (timeAgo.TotalDays < 1)
                                {
                                    <text>Updated @((int)timeAgo.TotalHours) hour@(timeAgo.TotalHours >= 2 ? "s" : "") ago</text>
                                }
                                else if (timeAgo.TotalDays < 30)
                                {
                                    <text>Updated @((int)timeAgo.TotalDays) day@(timeAgo.TotalDays >= 2 ? "s" : "") ago</text>
                                }
                                else
                                {
                                    <text>Updated @game.UpdatedDate.Value.ToString("MMM dd, yyyy")</text>
                                }
                            }
                            else
                            {
                                <text>Recently updated</text>
                            }
                        </div>

                        <div class="game-info-grid">
                            <div class="game-info-item">
                                <div class="game-info-icon icon-genre">
                                    <i class="bi bi-controller"></i>
                                </div>
                                <div>
                                    <div class="game-info-label">Genre</div>
                                    <div class="game-info-value">@game.GenreName</div>
                                </div>
                            </div>

                            <div class="game-info-item">
                                <div class="game-info-icon icon-publisher">
                                    <i class="bi bi-building"></i>
                                </div>
                                <div>
                                    <div class="game-info-label">Publisher</div>
                                    <div class="game-info-value">@game.Publisher</div>
                                </div>
                            </div>

                            <div class="game-info-item">
                                <div class="game-info-icon icon-price">
                                    <i class="bi bi-tag-fill"></i>
                                </div>
                                <div>
                                    <div class="game-info-label">Price</div>
                                    <div class="game-price">$@game.Price</div>
                                </div>
                            </div>

                            <div class="game-info-item">
                                @if (game.Quantity.HasValue && game.Quantity.Value > 0)
                                {
                                    <div class="game-info-icon icon-stock">
                                        <i class="bi bi-check-circle-fill"></i>
                                    </div>
                                    <div>
                                        <div class="game-info-label">Stock</div>
                                        <div class="stock-badge stock-in">
                                            @game.Quantity units available
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="game-info-icon icon-stock-out">
                                        <i class="bi bi-x-circle-fill"></i>
                                    </div>
                                    <div>
                                        <div class="game-info-label">Stock</div>
                                        <div class="stock-badge stock-out">
                                            Out of Stock
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        @if (game.Quantity.HasValue && game.Quantity.Value > 0)
                        {
                            <button type="button" onclick="add(@game.Id)" class="btn-add-cart">
                                <i class="bi bi-cart-plus"></i> Add to Cart
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn-add-cart" disabled>
                                <i class="bi bi-x-circle"></i> Out of Stock
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Pagination Controls -->
@if (Model.TotalPages > 1)
{
    <nav aria-label="Game pagination" class="mt-5 mb-4">
        <ul class="pagination justify-content-center">
            <!-- Previous Button -->
            @if (Model.CurrentPage > 1)
            {
                <li class="page-item">
                    <a class="page-link" href="@Url.Action("Index", new { sTerm = Model.STerm, genreId = Model.GenreId, maxPrice = Model.SelectedMaxPrice, page = Model.CurrentPage - 1 })" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            }
            else
            {
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&laquo;</span>
                </li>
            }

            <!-- Page Numbers -->
            @{
                int startPage = Math.Max(1, Model.CurrentPage - 2);
                int endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                
                if (startPage > 1)
                {
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Index", new { sTerm = Model.STerm, genreId = Model.GenreId, maxPrice = Model.SelectedMaxPrice, page = 1 })">1</a>
                    </li>
                    if (startPage > 2)
                    {
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    }
                }

                for (int i = startPage; i <= endPage; i++)
                {
                    <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Index", new { sTerm = Model.STerm, genreId = Model.GenreId, maxPrice = Model.SelectedMaxPrice, page = i })">@i</a>
                    </li>
                }

                if (endPage < Model.TotalPages)
                {
                    if (endPage < Model.TotalPages - 1)
                    {
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    }
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Index", new { sTerm = Model.STerm, genreId = Model.GenreId, maxPrice = Model.SelectedMaxPrice, page = Model.TotalPages })">@Model.TotalPages</a>
                    </li>
                }
            }

            <!-- Next Button -->
            @if (Model.CurrentPage < Model.TotalPages)
            {
                <li class="page-item">
                    <a class="page-link" href="@Url.Action("Index", new { sTerm = Model.STerm, genreId = Model.GenreId, maxPrice = Model.SelectedMaxPrice, page = Model.CurrentPage + 1 })" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            }
            else
            {
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&raquo;</span>
                </li>
            }
        </ul>
    </nav>
}


<!-- Floating Action Button -->
<div class="position-fixed bottom-0 end-0 p-4" style="z-index: 1030">
    <button class="btn btn-primary rounded-circle shadow-lg p-3" style="width: 60px; height: 60px;" data-bs-toggle="modal" data-bs-target="#recommendationModal" title="Get AI Recommendation">
        <i class="bi bi-stars fs-4"></i>
    </button>
</div>

<!-- Recommendation Modal -->
<div class="modal fade" id="recommendationModal" tabindex="-1" aria-labelledby="recommendationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="recommendationModalLabel">
                    <i class="bi bi-stars text-warning"></i> AI Game Matcher
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">Describe what you're looking for, and let AI find your next favorite game!</p>
                <form id="recommendationForm">
                    <div class="mb-3">
                        <label for="aiGenre" class="form-label">Genre Preference (Optional)</label>
                        <select class="form-select" id="aiGenre">
                            <option value="">Any Genre</option>
                            @foreach (var genre in Model.Genres)
                            {
                                <option value="@genre.GenreName">@genre.GenreName</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="aiPrompt" class="form-label">What kind of game do you want?</label>
                        <textarea class="form-control" id="aiPrompt" rows="3" placeholder="e.g., A relaxing farming simulator with RPG elements..."></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-modern" id="btnGetRecommendation">
                            <span class="spinner-border spinner-border-sm d-none" id="aiSpinner" role="status" aria-hidden="true"></span>
                            <span id="aiButtonText"><i class="bi bi-stars"></i> Get Recommendation</span>
                        </button>
                    </div>
                </form>
                
                <div id="aiResult" class="mt-4 d-none">
                    <h6 class="border-bottom pb-2 mb-3">Recommendation</h6>
                    <div class="p-3 bg-light rounded" id="aiResponseText" style="white-space: pre-wrap;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function add(gameId) {
        var userNameEl = document.getElementById('username');
        if (userNameEl == null) {
            window.location.href = '/Identity/Account/Login';
        } else {
            try {
                console.log('Adding game to cart:', gameId);
                var response = await fetch(`/Cart/AddItem?gameId=${gameId}`);
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    var result = await response.json();
                    console.log('Cart count updated to:', result);
                    
                    var cartCountElement = document.getElementById('cartCount');
                    if (cartCountElement) {
                        cartCountElement.innerHTML = result;
                        console.log('Cart badge updated successfully');
                    } else {
                        console.error('cartCount element not found');
                    }
                    window.location.href = '#cartCount';

                } else {
                    console.error('Failed to add item. Status:', response.status);
                    var errorText = await response.text();
                    console.error('Error details:', errorText);
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
            }
        }
    }

    document.getElementById('recommendationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const prompt = document.getElementById('aiPrompt').value;
        const genre = document.getElementById('aiGenre').value;
        const btn = document.getElementById('btnGetRecommendation');
        const spinner = document.getElementById('aiSpinner');
        const btnText = document.getElementById('aiButtonText');
        const resultDiv = document.getElementById('aiResult');
        const responseText = document.getElementById('aiResponseText');

        if (!prompt) {
            alert('Please describe what you are looking for.');
            return;
        }

        // UI Loading State
        btn.disabled = true;
        spinner.classList.remove('d-none');
        btnText.innerText = ' Thinking...';
        resultDiv.classList.add('d-none');

        try {
            const response = await fetch(`/Home/GetRecommendation?prompt=${encodeURIComponent(prompt)}&genre=${encodeURIComponent(genre)}`);
            
            if (response.ok) {
                const data = await response.text();
                 // Check if the response itself contains an error message from the service
                if (data.startsWith("Error from Gemini API") || data.startsWith("Please configure")) {
                     if (data.includes("429") || data.includes("Quota") || data.includes("RESOURCE_EXHAUSTED")) {
                        responseText.innerHTML = `
                            <div class="text-danger">
                                <i class="bi bi-exclamation-triangle-fill"></i> <strong>Quota Exceeded</strong><br>
                                The AI service is currently busy or the daily limit has been reached. Please try again later.
                            </div>`;
                    } else {
                        responseText.innerText = data;
                    }
                } else {
                    responseText.innerText = data;
                }
                resultDiv.classList.remove('d-none');
            } else {
                // HTTP Error
                if (response.status === 429) {
                     responseText.innerHTML = `
                        <div class="text-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i> <strong>Quota Exceeded</strong><br>
                            You have exceeded the API rate limit. Please check your plan or try again later.
                        </div>`;
                } else {
                    responseText.innerText = "Failed to get recommendation. Server returned " + response.status;
                }
                 resultDiv.classList.remove('d-none');
            }

        } catch (error) {
            console.error('Error:', error);
             responseText.innerHTML = `
                <div class="text-danger">
                    <i class="bi bi-wifi-off"></i> <strong>Network Error</strong><br>
                    Could not connect to the recommendation service.
                </div>`;
             resultDiv.classList.remove('d-none');
        } finally {
            // Reset UI
            btn.disabled = false;
            spinner.classList.add('d-none');
            btnText.innerHTML = '<i class="bi bi-stars"></i> Get Recommendation';
        }
    });
</script>
